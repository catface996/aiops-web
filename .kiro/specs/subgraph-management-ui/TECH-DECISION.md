# 技术决策：拓扑图可视化实现

**决策日期**: 2024-12-04  
**决策人**: 技术团队  
**状态**: 已确认 ✅

---

## 决策背景

F08子图管理功能需要实现拓扑图可视化，用于展示子图内资源节点及其关系。需要选择合适的技术方案。

---

## 候选方案

### 方案1: AntV G6
- **描述**: 阿里开源的图可视化引擎
- **优势**:
  - 与Ant Design风格统一
  - 功能强大，支持复杂图形
  - 文档完善，社区活跃
  - 内置多种布局算法
- **劣势**:
  - 学习曲线较陡
  - 包体积较大（~200KB）
  - 需要额外学习API
  - 可能存在过度设计

### 方案2: React Flow
- **描述**: React原生的流程图/拓扑图库
- **优势**:
  - React原生支持，易于集成
  - 性能优秀
  - API简洁直观
  - 包体积适中（~100KB）
- **劣势**:
  - 主要面向流程图场景
  - 自定义样式需要额外工作
  - 与Ant Design风格不完全匹配

### 方案3: 自定义SVG实现 ✅ **已选择**
- **描述**: 基于React + SVG + CSS的自定义组件
- **优势**:
  - 完全控制渲染和交互逻辑
  - 轻量级（无外部依赖）
  - 可根据需求高度定制
  - 中等规模图（<500节点）性能优秀
  - **已在F04功能中实现并验证**
- **劣势**:
  - 需要自己实现交互逻辑
  - 复杂布局算法需要自己开发
  - 维护成本相对较高

---

## 决策结果

**选择方案3：自定义SVG实现**

### 决策理由

1. **已有实现**：F04功能已经实现了完整的拓扑图可视化组件，包括：
   - 节点拖拽和位置持久化
   - 缩放和平移
   - 连接点创建关系
   - 节点和边的选择
   - 双击打开详情
   - 自动布局算法

2. **代码复用**：可以直接复用F04的组件，只需要适配子图范围过滤逻辑

3. **轻量级**：无需引入额外的第三方库，减少包体积和依赖

4. **性能验证**：F04已经验证了该方案在中等规模图（<500节点）下的性能表现

5. **定制化**：完全控制渲染和交互，可以根据子图管理的特定需求进行定制

6. **维护成本**：虽然需要自己维护，但代码已经成熟稳定

---

## 实现细节

### 核心组件

```
src/pages/Topology/components/
├── TopologyCanvas.tsx       # 主画布组件，管理交互
├── TopologyNode.tsx         # 节点组件，支持拖拽
├── TopologyEdge.tsx         # 边组件，支持箭头标记
└── RelationModal.tsx        # 关系创建/编辑弹窗
```

### 功能特性

1. **节点交互**
   - 拖拽移动节点
   - 点击选择节点
   - 双击打开节点详情
   - 位置持久化到LocalStorage

2. **边交互**
   - 通过连接点创建关系
   - 点击选择边
   - 双击编辑关系
   - 箭头标记显示方向

3. **画布交互**
   - 鼠标滚轮缩放
   - 拖拽平移
   - 空格+拖拽平移
   - 点击空白取消选择

4. **布局算法**
   - 自动网格布局（初始化）
   - 保存用户调整的位置
   - 恢复上次保存的布局

### 子图适配需求

F08子图管理需要在F04基础上进行以下适配：

1. **范围过滤**
   - 只显示子图内的节点
   - 只显示子图内节点之间的关系
   - 过滤掉与子图外节点的关系

2. **空状态处理**
   - 子图无节点时显示空状态
   - 子图有节点但无关系时显示提示

3. **权限控制**
   - Owner可以添加/移除节点
   - Viewer只能查看

4. **布局选择**（可选）
   - 提供多种布局算法选项
   - 记住用户的布局偏好

5. **导出功能**（可选）
   - 导出为PNG图片
   - 导出为SVG图片

---

## 性能考虑

### 性能指标

- **节点数量**: <500个节点
- **关系数量**: <1000条关系
- **渲染时间**: <3秒
- **交互响应**: <100ms

### 性能优化策略

1. **虚拟化**：大量节点时只渲染可见区域
2. **节流防抖**：拖拽和缩放事件使用节流
3. **批量更新**：使用React批量更新减少重渲染
4. **位置缓存**：缓存节点位置计算结果

---

## 风险评估

| 风险 | 概率 | 影响 | 缓解措施 | 状态 |
|------|------|------|---------|------|
| 性能问题（大量节点） | 低 | 高 | 限制节点数量<500，实现虚拟化 | 已缓解 |
| 组件复用适配问题 | 低 | 中 | F04组件设计良好，易于适配 | 已缓解 |
| 布局算法不满足需求 | 低 | 低 | 可以后续添加更多布局选项 | 可接受 |

---

## 后续优化

### 短期（MVP）
- [x] 复用F04组件
- [ ] 实现子图范围过滤
- [ ] 实现空状态处理
- [ ] 实现权限控制

### 中期
- [ ] 添加多种布局算法选项
- [ ] 实现导出功能
- [ ] 优化大量节点性能

### 长期
- [ ] 考虑节点聚合功能
- [ ] 考虑关系路径高亮
- [ ] 考虑时间轴功能

---

## 参考资料

- F04拓扑图实现: `src/pages/Topology/components/`
- SVG文档: https://developer.mozilla.org/en-US/docs/Web/SVG
- React事件处理: https://react.dev/learn/responding-to-events

---

**决策确认人**: 技术负责人  
**实施负责人**: 前端开发团队  
**审核日期**: 2024-12-04
